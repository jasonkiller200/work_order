# 採購儀錶板更新說明

## 更新日期：2025-11-30

## 主要功能更新

### 1. 物料詳情查看方式改進
- **舊方式**：整列點擊開啟模態視窗
- **新方式**：物料編號改為藍色底線連結樣式，點擊開啟詳情模態視窗
- **優點**：更符合使用者習慣，視覺上更清楚哪裡可以點擊

### 2. 採購人員參考與編輯功能
#### 2.1 查看採購人員參考清單
- 點擊採購人員欄位（藍色底線樣式）開啟參考清單模態視窗
- 顯示該物料前後各25筆物料的採購人員資訊（總共最多51筆）
- 當前查詢的物料會以**黃色背景**加粗突出顯示
- 方便採購人員參考附近物料的採購人員分配情況

#### 2.2 即時修改採購人員
- 在參考清單中，每個物料的採購人員都以**下拉選單**顯示
- 下拉選單自動載入系統中所有採購人員
- 變更下拉選單後**自動儲存**，無需額外按鈕
- 儲存成功時顯示綠色背景提示（1.5秒後消失）
- 儲存失敗時會顯示錯誤訊息並恢復原值
- 修改會立即反映在主儀錶板表格中

## 技術實作細節

### 前端修改（app/static/js/main.js）

#### 新增/修改的函數：
1. **addMaterialLinkListeners()** - 綁定物料連結點擊事件
2. **openBuyerReferenceModal()** - 開啟採購人員參考清單（含編輯功能）
3. **bindBuyerSelectEvents()** - 綁定下拉選單變更事件並處理自動儲存

#### 資料流程：
```
點擊採購人員 → 載入參考清單 → 同時載入採購人員清單 
→ 渲染帶下拉選單的表格 → 變更下拉選單 
→ 發送POST請求到後端 → 更新快取資料 → 重新渲染主表格
```

### 後端修改（app/controllers/api_controller.py）

#### 新增的API端點：

1. **GET /api/buyers_list**
   - 功能：取得所有採購人員清單
   - 返回：排序後的採購人員名單和數量
   - 資料來源：從主儀表板和成品儀表板收集

2. **POST /api/update_buyer**
   - 功能：更新物料的採購人員
   - 參數：
     - material_id: 物料編號
     - buyer: 新的採購人員名稱
     - dashboard_type: 儀表板類型（main/finished）
   - 返回：成功狀態和更新後的資訊
   - 特性：直接更新快取中的資料

#### 現有API修改：

**GET /api/material/<material_id>/buyer_reference**
- 新增支援 dashboard_type 參數
- 根據當前儀表板類型返回對應的資料

### CSS樣式更新（app/static/css/style.css）

#### 新增的樣式類別：

1. **.material-link** - 物料編號連結樣式
   - 藍色文字 (#0066cc)
   - 底線
   - 懸停時變深藍加粗

2. **.buyer-cell** - 採購人員欄位樣式
   - 與物料連結相同的樣式
   - 確保統一的使用者體驗

3. **.buyer-select** - 採購人員下拉選單樣式
   - 適當的內邊距和最小寬度
   - 懸停和焦點時的邊框變化
   - 焦點時顯示藍色陰影

## 使用說明

### 查看物料詳情
1. 在採購儀錶板表格中找到目標物料
2. 點擊物料編號（藍色底線文字）
3. 彈出模態視窗顯示：
   - 庫存總覽
   - 需求訂單列表
   - 可替代版本庫存

### 查看並修改採購人員
1. 在採購儀錶板表格中找到目標物料
2. 點擊採購人員欄位（藍色底線文字）
3. 彈出模態視窗顯示該物料前後25筆的採購人員資訊
4. 當前物料會以黃色背景標示
5. 直接在下拉選單中選擇新的採購人員
6. 系統會自動儲存並更新（成功時顯示綠色提示）
7. 關閉模態視窗後，主表格會反映最新的採購人員資訊

## 注意事項

1. **資料持久性**：
   - 採購人員的修改目前只更新記憶體快取
   - 重新載入資料時會恢復到原始檔案的內容
   - 如需永久保存，需要實作資料庫或檔案寫入功能

2. **並行編輯**：
   - 如果多人同時編輯同一物料的採購人員
   - 後儲存的會覆蓋先儲存的
   - 建議在低併發環境下使用

3. **效能考慮**：
   - 每次變更都會發送API請求
   - 在網路不穩定時可能會有延遲
   - 失敗時會自動恢復原值

## 未來改進方向

1. 實作採購人員變更的資料庫持久化
2. 加入批次修改功能
3. 記錄採購人員變更歷史
4. 加入權限控制（只有特定使用者可以修改）
5. 加入樂觀鎖機制避免並行編輯衝突
6. 加入離線編輯支援

## 測試建議

1. 測試物料詳情連結是否正常開啟模態視窗
2. 測試採購人員參考清單是否正確顯示前後25筆
3. 測試下拉選單是否包含所有採購人員
4. 測試修改採購人員後是否成功儲存
5. 測試主表格是否即時更新
6. 測試成功/失敗的視覺反饋
7. 測試在主儀表板和成品儀表板的功能是否正常

## 回滾方案

如需回滾到舊版本，請還原以下檔案：
- app/static/js/main.js
- app/controllers/api_controller.py
- app/static/css/style.css

或者使用 git 還原到更新前的 commit。
