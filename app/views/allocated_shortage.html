<!DOCTYPE html>
<html lang="zh-Hant" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿç”¢è³‡è¨Šä¸­å¿ƒ - å·²æ’¥ç¼ºæ–™</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pico.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=1234">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/modals.css') }}?v=1234">
    <!-- Flatpickr æ—¥æœŸé¸æ“‡å™¨ (Dark Theme) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/flatpickr-dark.css') }}">
    <!-- å‡æ—¥æ¨£å¼ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/holiday.css') }}">
    <style>
        .clickable-material {
            cursor: pointer;
            color: var(--pico-primary);
        }
        .clickable-material:hover {
            text-decoration: underline;
        }
        .clickable-order {
            cursor: pointer;
            color: var(--pico-primary);
            text-decoration: underline;
        }
        .clickable-order:hover {
            color: var(--pico-primary-hover);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-link.active {
            border-bottom-color: var(--pico-primary) !important;
            color: var(--pico-primary) !important;
            font-weight: bold;
        }
        .table-container {
            max-height: 700px;
            overflow-y: auto;
            overflow-x: auto;
        }
        .table-container thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #11191f;
            border-bottom: 2px solid var(--pico-muted-border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .no-arrival-date {
            color: #f44336;
            font-weight: bold;
        }
        .has-arrival-date {
            color: #4caf50;
        }
        .orders-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3em;
        }
        .order-badge {
            display: inline-block;
            padding: 0.15em 0.5em;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
        }
        .order-badge:hover {
            background: rgba(59, 130, 246, 0.4);
        }
        .stat-summary {
            display: flex;
            gap: 2em;
            margin-bottom: 1em;
            padding: 1em;
            background: var(--pico-card-background-color);
            border-radius: 8px;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--pico-primary);
        }
        .stat-label {
            font-size: 0.85em;
            color: var(--pico-muted-color);
        }
    </style>
</head>

<body>
    <!-- ç³»çµ±ç‹€æ…‹å¾½ç« ï¼ˆå³ä¸Šè§’ï¼‰ -->
    <div class="system-status-badge">
        <span class="status-indicator loading"></span>
        <span id="status-badge-text">æª¢æŸ¥ä¸­...</span>
    </div>

    <main class="container">
        <header>
            <h1>ç”Ÿç”¢è³‡è¨Šä¸­å¿ƒ</h1>
            <p>ä¸€å€‹æ•´åˆå·¥å–®æ–™æ³ã€åº«å­˜èˆ‡è¦æ ¼çš„æŸ¥è©¢ç³»çµ±</p>
        </header>

        <nav>
            <ul>
                <li><a href="/procurement">æ¡è³¼å„€è¡¨æ¿</a></li>
                <li><a href="/allocated-shortage" class="active">å·²æ’¥ç¼ºæ–™</a></li>
                <li><a href="/order_query">è¨‚å–®æŸ¥è©¢</a></li>
                <li><a href="/open-purchase-orders">æœªçµæ¡ˆæ¡è³¼å–®</a></li>
                <li><a href="/admin_dashboard">å¾Œå°ç®¡ç†</a></li>
                {% if is_admin %}
                <li><a href="/part-drawing-management">å“è™Ÿ-åœ–è™Ÿç¶­è­·</a></li>
                <li><a href="/component-requirements">æˆå“çµ„ä»¶éœ€æ±‚</a></li>
                {% endif %}
                <li><a href="/work-order-statistics">å·¥å–®è©³æƒ…çµ±è¨ˆ</a></li>
            </ul>
        </nav>

        <hr>

        <section id="allocated-shortage-section">
            <h2>ğŸ“¦ å·²æ’¥ç¼ºæ–™ç¸½è¦½</h2>
            <p style="color: var(--pico-muted-color); margin-bottom: 1em;">
                é¡¯ç¤ºé ˜æ–™ç³»çµ±å·²æ’¥å‡ºä½†ä»ç¼ºæ–™çš„ç‰©æ–™æ¸…å–®
            </p>

            <!-- é ç±¤å°èˆª -->
            <nav class="shortage-tabs" style="margin-bottom: 1em;">
                <ul>
                    <li><a href="#" class="tab-link active" data-tab="semi-tab">ğŸ“¦ åŠæˆå“ç¼ºæ–™</a></li>
                    <li><a href="#" class="tab-link" data-tab="finished-tab">ğŸ­ æˆå“ç¼ºæ–™</a></li>
                </ul>
            </nav>

            <!-- åŠæˆå“ç¼ºæ–™é ç±¤ -->
            <div id="semi-tab" class="tab-content active">
                <!-- çµ±è¨ˆæ‘˜è¦ -->
                <div class="stat-summary">
                    <div class="stat-item">
                        <span class="stat-number" id="semi-total-count">-</span>
                        <span class="stat-label">ç¸½ç¼ºæ–™é …ç›®</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number no-arrival-date" id="semi-no-date-count">-</span>
                        <span class="stat-label">ç„¡äº¤æœŸé …ç›®</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number has-arrival-date" id="semi-has-date-count">-</span>
                        <span class="stat-label">å·²æœ‰äº¤æœŸ</span>
                    </div>
                </div>

                <!-- è³‡æ–™è¡¨æ ¼ -->
                <div class="table-container">
                    <table id="semi-table">
                        <thead>
                            <tr>
                                <th>ç‰©æ–™ç·¨è™Ÿ</th>
                                <th>å“å</th>
                                <th>ç¼ºæ–™æ•¸é‡</th>
                                <th>é—œè¯è¨‚å–®</th>
                                <th>é è¨ˆåˆ°è²¨æ—¥</th>
                            </tr>
                        </thead>
                        <tbody id="semi-tbody">
                            <tr><td colspan="5" style="text-align: center;">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æˆå“ç¼ºæ–™é ç±¤ -->
            <div id="finished-tab" class="tab-content">
                <!-- çµ±è¨ˆæ‘˜è¦ -->
                <div class="stat-summary">
                    <div class="stat-item">
                        <span class="stat-number" id="finished-total-count">-</span>
                        <span class="stat-label">ç¸½ç¼ºæ–™é …ç›®</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number no-arrival-date" id="finished-no-date-count">-</span>
                        <span class="stat-label">ç„¡äº¤æœŸé …ç›®</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number has-arrival-date" id="finished-has-date-count">-</span>
                        <span class="stat-label">å·²æœ‰äº¤æœŸ</span>
                    </div>
                </div>

                <!-- è³‡æ–™è¡¨æ ¼ -->
                <div class="table-container">
                    <table id="finished-table">
                        <thead>
                            <tr>
                                <th>ç‰©æ–™ç·¨è™Ÿ</th>
                                <th>å“å</th>
                                <th>ç¼ºæ–™æ•¸é‡</th>
                                <th>é—œè¯è¨‚å–®</th>
                                <th>é è¨ˆåˆ°è²¨æ—¥</th>
                            </tr>
                        </thead>
                        <tbody id="finished-tbody">
                            <tr><td colspan="5" style="text-align: center;">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </section>
    </main>

    <!-- ç‰©æ–™è©³æƒ…å½ˆå‡ºè¦–çª— (Modal) - èˆ‡æ¡è³¼å„€è¡¨æ¿ç›¸åŒ -->
    <dialog id="details-modal">
        <article>
            <header>
                <a href="#close" aria-label="Close" class="close"></a>
                <h3 id="modal-title">ç‰©æ–™è©³æƒ…</h3>
            </header>

            <div class="modal-split-container"
                style="display: flex !important; gap: 1.5em; align-items: flex-start; min-height: 500px;">

                <!-- å·¦å´åˆ†æ¬„ï¼šåº«å­˜ã€è­¦ç¤ºèˆ‡è¡¨å–® -->
                <div class="modal-left-column"
                    style="flex: 0 0 60%; max-width: 60%; min-width: 60%; max-height: 80vh; overflow-y: auto; padding-right: 0.5em;">
                    <!-- åº«å­˜ç¸½è¦½å€å¡Š -->
                    <div id="stock-summary-section">
                        <h4>ğŸ“¦ åº«å­˜ç¸½è¦½</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em; margin-bottom: 0.5em;">
                            <p>æœªé™åˆ¶: <span id="unrestricted-stock" style="font-weight: bold; color: var(--color-success);"></span></p>
                            <p>å“æª¢ä¸­: <span id="inspection-stock" style="font-weight: bold; color: var(--color-warning);"></span></p>
                        </div>
                        <p>å·²è¨‚æœªå…¥ (PO): <span id="on-order-stock" style="font-weight: bold; color: var(--color-info);"></span></p>

                        <div id="shortage-alert" class="shortage-alert"
                            style="display: none; margin-top: 1em; padding: 0.8em; border-radius: 4px; background: rgba(211, 47, 47, 0.1); border-left: 4px solid var(--color-danger);">
                            <p style="margin: 0; font-weight: bold; color: var(--color-danger);">âš ï¸ ç•¶å‰ç¼ºæ–™: <strong id="current-shortage-qty">0</strong> ä»¶</p>
                            <p style="margin: 0.3em 0 0 0; font-size: 0.85em; color: var(--text-secondary);">ğŸ“… é–‹å§‹ç¼ºæ–™æ—¥: <strong id="earliest-demand-date">-</strong></p>
                        </div>
                    </div>

                    <!-- ç›¸é—œæ¡è³¼å–®å€å¡Š -->
                    <div id="purchase-orders-section" style="margin-bottom: 1.5em; display: none;">
                        <h4 class="purchase-orders-title">ğŸ“‹ ç›¸é—œæ¡è³¼å–® (SAP)</h4>
                        <div style="overflow-x: auto; max-height: 200px;">
                            <table style="font-size: 0.8em; width: 100%;">
                                <thead>
                                    <tr>
                                        <th>å–®è™Ÿ</th>
                                        <th>æ•¸é‡</th>
                                        <th>äº¤æœŸ</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="purchase-orders-tbody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- äº¤æœŸç¶­è­·è¡¨å–® -->
                    <div id="delivery-form-section" class="delivery-form-section">
                        <h4 class="delivery-form-title">ğŸ“… äº¤æœŸ/åˆ†æ‰¹ç¶­è­·</h4>
                        <form id="delivery-form">
                            <div style="margin-bottom: 0.5em;">
                                <label for="po-select" style="font-size: 0.85em; margin-bottom: 2px; display: block;">é—œè¯æ¡è³¼å–®</label>
                                <select id="po-select" style="font-size: 0.9em; padding: 4px; height: auto; margin-bottom: 0;">
                                    <option value="">-- æ–°å»º (ä¸é—œè¯) --</option>
                                </select>
                            </div>

                            <div style="display: grid; grid-template-columns: 1.2fr 1fr; gap: 0.5em;">
                                <div>
                                    <label for="delivery-date" style="font-size: 0.85em; margin-bottom: 2px;">é è¨ˆåˆ°è²¨ <span class="required-mark">*</span></label>
                                    <input type="text" id="delivery-date" style="font-size: 0.85em; padding: 4px; height: auto;" placeholder="é¸æ“‡æ—¥æœŸ..." required>
                                    <small style="color: var(--pico-muted-color); font-size: 0.7em; display: block; margin-top: 0.2em;">
                                        ğŸ’¡ æç¤º: é»æ“Šæ¬„ä½é–‹å•Ÿæ—¥æœŸé¸æ“‡å™¨
                                    </small>
                                </div>
                                <div>
                                    <label for="delivery-qty" style="font-size: 0.85em; margin-bottom: 2px;">æ•¸é‡ <span class="required-mark">*</span></label>
                                    <input type="number" id="delivery-qty" min="1" style="font-size: 0.85em; padding: 4px; height: auto;" placeholder="æ•¸é‡" required>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em; margin-top: 0.5em;">
                                <div>
                                    <label for="po-number" style="font-size: 0.8em;">æ¡è³¼å–®è™Ÿ</label>
                                    <input type="text" id="po-number" style="font-size: 0.85em; padding: 4px; height: auto;" placeholder="é¸å¡«">
                                </div>
                                <div>
                                    <label for="supplier" style="font-size: 0.8em;">ä¾›æ‡‰å•†</label>
                                    <input type="text" id="supplier" style="font-size: 0.85em; padding: 4px; height: auto;" placeholder="é¸å¡«">
                                </div>
                            </div>

                            <textarea id="delivery-notes" rows="1" placeholder="å‚™è¨»..."
                                style="margin-top: 0.5em; font-size: 0.85em; padding: 4px; height: auto;"></textarea>

                            <div id="delivery-calculation"
                                style="display: none; margin-top: 0.5em; background: rgba(33, 150, 243, 0.1); padding: 8px; border-radius: 4px; border-left: 3px solid var(--color-info);">
                                <p style="margin: 0; font-size: 0.85em; color: var(--color-info);">âœ… åˆ°è²¨å¾Œå¯ç”¨: <strong id="calc-available-stock">0</strong></p>
                                <p style="margin: 0; font-size: 0.8em; color: var(--text-secondary);">æ»¿è¶³è‡³: <strong id="calc-satisfy-until">-</strong></p>
                            </div>

                            <div style="margin-top: 0.8em; display: flex; gap: 0.4em;">
                                <button type="button" id="save-delivery-btn" style="flex: 1.5; padding: 4px 8px; font-size: 0.9em;">ğŸ’¾ å„²å­˜</button>
                                <button type="button" id="clear-delivery-btn" class="secondary" style="flex: 1; padding: 4px 8px; font-size: 0.9em;">ğŸ—‘ï¸ æ¸…é™¤</button>
                            </div>
                        </form>

                        <details style="margin-top: 0.8em; font-size: 0.85em;">
                            <summary>ğŸ“œ äº¤æœŸæ­·å²è¨˜éŒ„</summary>
                            <div id="delivery-history" style="max-height: 200px; overflow-y: auto; margin-top: 0.5em; border-top: 1px dashed var(--pico-border-color); padding-top: 0.5em;"></div>
                        </details>
                    </div>
                </div>

                <!-- å³å´åˆ†æ¬„ï¼šéœ€æ±‚è¨‚å–® -->
                <div class="modal-right-column"
                    style="flex: 0 0 40%; max-width: 40%; min-width: 40%; max-height: 80vh; overflow-y: auto; border-left: 1px solid var(--pico-border-color); padding-left: 1.5em;">
                    <nav style="margin-bottom: 0.5em;">
                        <ul>
                            <li><a href="#" class="tab-link active" data-tab="tab-demand">ğŸ“Š è¨‚å–®éœ€æ±‚</a></li>
                            <li><a href="#" class="tab-link" data-tab="tab-substitute">ğŸ”„ æ›¿ä»£å“/ç‰ˆæœ¬</a></li>
                        </ul>
                    </nav>

                    <div id="modal-content">
                        <div id="tab-demand" class="tab-content active">
                            <p style="color: var(--pico-muted-color);">è¼‰å…¥éœ€æ±‚ä¸­...</p>
                        </div>
                        <div id="tab-substitute" class="tab-content">
                            <div id="substitute-section">
                                <p style="color: var(--pico-muted-color);">è¼‰å…¥æ›¿ä»£å“ä¸­...</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <footer>
                <button class="secondary" id="close-modal-btn" style="margin: 0;">é—œé–‰è¦–çª—</button>
            </footer>
        </article>
    </dialog>

    <!-- å·¥å–®ç¼ºæ–™æ˜ç´°å½ˆå‡ºè¦–çª— -->
    <dialog id="shortage-modal">
        <article style="min-width: 900px; max-width: 95vw;">
            <header>
                <a href="#close" aria-label="Close" class="close" id="close-shortage-modal"></a>
                <h3 id="shortage-modal-title">å·¥å–®ç¼ºæ–™æ˜ç´°</h3>
            </header>
            <div id="shortage-modal-content">
                <div style="margin-bottom: 1em;">
                    <span id="shortage-summary"></span>
                </div>
                <div style="overflow-x: auto; max-height: 60vh;">
                    <table>
                        <thead>
                            <tr>
                                <th>ç‰©æ–™ç·¨è™Ÿ</th>
                                <th>ç‰©æ–™èªªæ˜</th>
                                <th>éœ€æ±‚æ•¸é‡</th>
                                <th>æœªé™åˆ¶</th>
                                <th>å“æª¢ä¸­</th>
                                <th>ç‹€æ…‹</th>
                                <th>éœ€æ±‚æ—¥æœŸ</th>
                                <th>æ¡è³¼äººå“¡</th>
                                <th>é è¨ˆäº¤è²¨æ—¥</th>
                            </tr>
                        </thead>
                        <tbody id="shortage-details-tbody"></tbody>
                    </table>
                </div>
            </div>
            <footer>
                <button class="secondary" id="close-shortage-btn">é—œé–‰</button>
            </footer>
        </article>
    </dialog>

    <!-- æ¡è³¼äººå“¡ç·¨è¼¯å½ˆå‡ºè¦–çª— -->
    <dialog id="buyer-modal">
        <article style="min-width: 600px;">
            <header>
                <a href="#close" aria-label="Close" class="close" id="close-buyer-modal"></a>
                <h3>æ¡è³¼äººå“¡åƒè€ƒæ¸…å–®</h3>
            </header>
            <div id="buyer-modal-content" style="max-height: 70vh; overflow-y: auto;">
                <p>è¼‰å…¥ä¸­...</p>
            </div>
        </article>
    </dialog>

    <!-- JS è¼‰å…¥ -->
    <script src="{{ url_for('static', filename='js/delivery-helper.js') }}?v=1232"></script>
    <script src="{{ url_for('static', filename='js/services/api-service.js') }}?v=1232"></script>
    <!-- Flatpickr JS -->
    <script src="{{ url_for('static', filename='js/flatpickr.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/flatpickr_zh_tw.js') }}"></script>
    <!-- å°ç£å‡æ—¥å·¥å…· -->
    <script src="{{ url_for('static', filename='js/utils/holiday_utils.js') }}"></script>
    <!-- ç‰©æ–™è©³æƒ…æ¨¡æ…‹è¦–çª— -->
    <script src="{{ url_for('static', filename='js/modules/material-modal.js') }}?v=1235"></script>
    <!-- å·²æ’¥ç¼ºæ–™é é¢é‚è¼¯ -->
    <script src="{{ url_for('static', filename='js/allocated-shortage.js') }}?v=1000"></script>
    <!-- å¿«å–åˆ·æ–°æ¨¡çµ„ -->
    <script src="{{ url_for('static', filename='js/cache-refresh.js') }}?v=1235"></script>
</body>

</html>
