# 採購人員資料庫同步功能說明

## 更新日期：2025-11-30

## 功能概述

實作了兩個重要功能：
1. **採購人員修改自動寫入資料庫**
2. **訂單需求物料自動同步到資料庫**

---

## 1. 採購人員修改資料庫寫入功能

### 功能說明

當使用者在採購儀錶板透過下拉選單修改物料的採購人員時：
1. ✅ 更新記憶體快取（即時生效於儀錶板）
2. ✅ 同步更新資料庫 `materials` 資料表
3. ✅ 自動建立物料記錄（如果該物料不存在）
4. ✅ 記錄操作日誌

### 實作細節

#### 修改的檔案：`app/controllers/api_controller.py`

**API 端點：** `POST /api/update_buyer`

**處理流程：**
```python
1. 接收前端傳來的物料編號和新採購人員名稱
2. 更新記憶體快取中的採購人員資訊
3. 查詢 users 資料表找到對應的採購人員 ID
4. 查詢 materials 資料表：
   - 如果物料存在：更新 buyer_id 和 updated_at
   - 如果物料不存在：自動新增物料記錄
5. 提交資料庫交易
6. 返回成功狀態和是否為新建物料
```

**新增欄位：**
```python
{
    "success": True,
    "material_id": "物料編號",
    "buyer": "採購人員名稱",
    "database_updated": True,  # 資料庫是否成功更新
    "auto_created": False      # 是否為自動建立的新物料
}
```

**錯誤處理：**
- 資料庫操作失敗時會自動 rollback
- 即使資料庫失敗，快取仍會更新（保證前端即時生效）
- 返回警告訊息告知使用者資料庫寫入狀態

**程式碼關鍵部分：**
```python
# 查找或建立採購人員
buyer = User.query.filter_by(full_name=new_buyer_name, role='buyer').first()

# 查找或建立物料
material_record = Material.query.filter_by(material_id=material_id).first()

if material_record:
    # 更新現有物料
    material_record.buyer_id = buyer.id if buyer else None
    material_record.updated_at = datetime.utcnow()
else:
    # 自動新增物料
    material_record = Material(
        material_id=material_id,
        description=material_description,
        base_material_id=base_material_id,
        buyer_id=buyer.id if buyer else None
    )
    db.session.add(material_record)

db.session.commit()
```

---

## 2. 訂單需求物料自動同步功能

### 功能說明

系統每次重新載入資料時（從 Excel 檔案），會自動：
1. ✅ 掃描所有訂單需求中的物料
2. ✅ 檢查 `materials` 資料表中是否存在
3. ✅ 自動新增不存在的物料到資料庫
4. ✅ 根據前10碼自動配對採購人員

### 實作細節

#### 修改的檔案：`app/services/data_service.py`

**新增方法：** `_sync_materials_to_database()`

**執行時機：**
- 在 `load_and_process_data()` 完成資料處理後自動執行
- 每次系統重新載入資料時都會執行

**處理流程：**
```python
1. 合併主儀表板和成品儀表板的需求資料
2. 去除重複物料，取得唯一物料清單
3. 過濾掉物料編號以 '08' 開頭的物料
4. 逐筆檢查物料是否已存在於資料庫：
   - 存在：跳過
   - 不存在：新增物料記錄
5. 根據 base_material_id（前10碼）自動配對採購人員
6. 每 100 筆提交一次，避免記憶體問題
7. 記錄同步統計資訊
```

**同步統計：**
- 新增物料數量
- 跳過已存在物料數量
- 錯誤數量

**效能優化：**
- 批次提交（每 100 筆）
- 單筆錯誤不影響整體處理
- 詳細的日誌記錄

**程式碼關鍵部分：**
```python
# 合併所有需求物料
all_materials_df = pd.concat([df_demand, df_finished_demand], ignore_index=True)

# 去重
unique_materials = all_materials_df[['物料', '物料說明']].drop_duplicates(subset=['物料'])

# 過濾 08 開頭
unique_materials = unique_materials[~unique_materials['物料'].astype(str).str.startswith('08')]

for _, row in unique_materials.iterrows():
    material_id = str(row['物料'])
    
    # 檢查是否已存在
    existing_material = Material.query.filter_by(material_id=material_id).first()
    if existing_material:
        skip_count += 1
        continue
    
    # 自動配對採購人員
    buyer_name = material_buyer_map.get(base_material_id)
    if buyer_name:
        buyer = User.query.filter_by(full_name=buyer_name, role='buyer').first()
    
    # 建立新物料
    new_material = Material(
        material_id=material_id,
        description=description,
        base_material_id=base_material_id,
        buyer_id=buyer.id if buyer else None
    )
    db.session.add(new_material)
    sync_count += 1
    
    # 每 100 筆提交一次
    if sync_count % 100 == 0:
        db.session.commit()
```

---

## 資料庫表結構

### materials 資料表

```sql
CREATE TABLE materials (
    id INTEGER PRIMARY KEY,
    material_id VARCHAR(50) UNIQUE NOT NULL,    -- 完整物料編號
    description VARCHAR(200),                    -- 物料說明
    base_material_id VARCHAR(50),               -- 基礎物料編號（前10碼）
    storage_location VARCHAR(50),               -- 儲存地點
    base_unit VARCHAR(20),                      -- 基礎單位
    buyer_id INTEGER,                           -- 採購人員ID (外鍵)
    lead_time_days INTEGER DEFAULT 0,           -- 交期天數
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (buyer_id) REFERENCES users(id)
);
```

### users 資料表

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255),
    full_name VARCHAR(100),                     -- 完整姓名（用於配對）
    email VARCHAR(100),
    department VARCHAR(100),
    role VARCHAR(20) DEFAULT 'buyer',           -- admin, buyer, viewer
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

## 使用流程

### 場景一：使用者修改採購人員

1. 使用者在採購儀錶板點擊採購人員欄位
2. 彈出參考清單模態視窗
3. 選擇下拉選單中的新採購人員
4. 系統自動：
   - 更新前端顯示（立即生效）
   - 更新記憶體快取
   - 寫入資料庫
   - 顯示綠色提示（成功）或錯誤訊息（失敗）

### 場景二：系統自動同步物料

1. 管理者更新 Excel 資料檔案
2. 系統重新載入資料
3. 自動掃描所有訂單需求物料
4. 檢查並新增不存在的物料到資料庫
5. 記錄同步統計到日誌

---

## 日誌範例

### 採購人員更新日誌
```
INFO: 更新物料 10100028620 的採購人員為: 王小明
INFO: 已更新物料 10100028620 的採購人員為: 王小明
```

### 物料同步日誌
```
INFO: 開始同步物料到資料庫，共 1234 筆物料
INFO: 已同步 100 筆物料到資料庫
INFO: 已同步 200 筆物料到資料庫
...
INFO: 物料同步完成: 新增 456 筆, 跳過 778 筆已存在物料, 錯誤 0 筆
```

---

## 錯誤處理

### 1. 採購人員不存在
- **情況**：選擇的採購人員在 users 資料表中找不到
- **處理**：buyer_id 設為 NULL，記錄警告日誌
- **影響**：不影響功能運作，物料仍會被建立/更新

### 2. 資料庫連接失敗
- **情況**：資料庫無法連接或交易失敗
- **處理**：rollback 交易，快取仍保持更新
- **回應**：返回警告訊息告知使用者
- **影響**：前端功能正常，但資料庫未更新

### 3. 物料資料不完整
- **情況**：物料說明為空或其他欄位缺失
- **處理**：使用預設值或空字串
- **影響**：不影響同步，記錄警告日誌

---

## 測試建議

### 測試一：修改採購人員
1. ✅ 開啟採購儀錶板
2. ✅ 點擊任一物料的採購人員欄位
3. ✅ 在下拉選單中選擇新的採購人員
4. ✅ 確認顯示綠色提示（1.5秒）
5. ✅ 重新整理頁面，確認採購人員仍為修改後的值
6. ✅ 查詢資料庫確認 materials 表已更新

### 測試二：自動新增物料
1. ✅ 在訂單 Excel 中新增一筆新物料的需求
2. ✅ 重新啟動 Flask 應用或觸發資料重新載入
3. ✅ 檢查日誌確認同步統計
4. ✅ 查詢資料庫確認新物料已加入 materials 表

### 測試三：錯誤處理
1. ✅ 選擇一個不存在的採購人員（如果可能）
2. ✅ 確認系統記錄警告但不中斷
3. ✅ 模擬資料庫連接失敗（停止資料庫服務）
4. ✅ 確認前端仍顯示成功但有警告訊息

---

## SQL 查詢範例

### 查詢物料的採購人員
```sql
SELECT 
    m.material_id,
    m.description,
    u.full_name AS buyer_name,
    m.updated_at
FROM materials m
LEFT JOIN users u ON m.buyer_id = u.id
WHERE m.material_id = '10100028620';
```

### 查詢最近更新的物料
```sql
SELECT 
    m.material_id,
    m.description,
    u.full_name AS buyer_name,
    m.updated_at
FROM materials m
LEFT JOIN users u ON m.buyer_id = u.id
ORDER BY m.updated_at DESC
LIMIT 10;
```

### 查詢沒有採購人員的物料
```sql
SELECT 
    material_id,
    description,
    base_material_id
FROM materials
WHERE buyer_id IS NULL
ORDER BY material_id;
```

---

## 注意事項

1. **資料一致性**：
   - 記憶體快取和資料庫可能短暫不一致（資料庫失敗時）
   - 下次重新載入資料時會從 Excel 重新建立快取

2. **採購人員配對**：
   - 必須先在 users 資料表建立採購人員記錄
   - full_name 必須與 Excel 中的名稱完全一致
   - role 必須設為 'buyer'

3. **效能考量**：
   - 首次同步可能需要較長時間（視物料數量）
   - 後續只會新增新物料，已存在的會跳過
   - 批次提交（100筆）避免記憶體問題

4. **資料來源**：
   - 物料主要來自訂單需求（Excel 檔案）
   - 採購人員來自 `採購人員.xlsx` 檔案
   - base_material_id 用於配對（前10碼）

---

## 未來改進建議

1. **批次修改功能**：
   - 允許一次修改多個物料的採購人員
   - 提供批次匯入功能

2. **變更歷史記錄**：
   - 建立 material_history 資料表
   - 記錄採購人員變更歷史
   - 記錄變更人和變更時間

3. **資料驗證**：
   - 加強物料編號格式驗證
   - 檢查採購人員權限
   - 防止重複新增

4. **同步優化**：
   - 使用背景任務處理大量同步
   - 提供手動觸發同步的介面
   - 加入同步進度顯示

5. **權限控制**：
   - 只允許特定角色修改採購人員
   - 加入審核機制
   - 記錄操作日誌

---

## 相關檔案

- `app/controllers/api_controller.py` - API 端點實作
- `app/services/data_service.py` - 資料載入和同步服務
- `app/models/database.py` - 資料庫模型定義
- `app/static/js/main.js` - 前端採購人員編輯功能
- `採購人員.xlsx` - 採購人員對照表來源
