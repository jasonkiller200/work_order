# æ¡è³¼å–®åŒ¯å…¥è™•ç†èªªæ˜

## ğŸ“‹ å•é¡Œç¸½è¦½

### å•é¡Œ 1ï¼šç‰©æ–™è™Ÿç¢¼å‰10ç¢¼åŒ¹é…
- **éœ€æ±‚**ï¼šç‰©æ–™è™Ÿç¢¼ç‚º 12 ç¢¼ï¼Œå› ç‰ˆæœ¬å•é¡Œåªéœ€æ¯”å°å‰ 10 ç¢¼
- **ç›®çš„**ï¼šé¿å…ç‰ˆæœ¬éå¤šå°è‡´è³‡æ–™è†¨è„¹

### å•é¡Œ 2ï¼šå·²è¨‚æœªäº¤.XLSX è®Šæ›´æ™‚çš„è™•ç†
- **å ´æ™¯**ï¼šç•¶ Excel æª”æ¡ˆå…§å®¹æ›´æ–°æ™‚ï¼ŒåŒ¯å…¥è…³æœ¬æœƒå¦‚ä½•è™•ç†ï¼Ÿ

### å•é¡Œ 3ï¼šç‰©æ–™ä¸å­˜åœ¨æ™‚çš„è™•ç†
- **å ´æ™¯**ï¼šå·²è¨‚æœªäº¤.XLSX ä¸­çš„ç‰©æ–™åœ¨ materials è¡¨ä¸­ä¸å­˜åœ¨

---

## ğŸ” è©³ç´°åˆ†æ

### ä¸€ã€`import_purchase_orders.py` çš„è™•ç†é‚è¼¯

#### 1. ç•¶å·²è¨‚æœªäº¤.XLSX æœ‰è®Šæ›´æ™‚

**è™•ç†æµç¨‹**ï¼ˆç¬¬ 68-77 è¡Œï¼‰ï¼š

```python
# æª¢æŸ¥æ¡è³¼å–®æ˜¯å¦å·²å­˜åœ¨
existing_po = PurchaseOrder.query.filter_by(po_number=po_number).first()

if existing_po:
    # âœ… æ›´æ–°ç¾æœ‰è¨˜éŒ„
    po = existing_po
else:
    # âœ… å»ºç«‹æ–°è¨˜éŒ„
    po = PurchaseOrder()
    po.po_number = po_number
```

**è™•ç†æ–¹å¼**ï¼š
- âœ… **å·²å­˜åœ¨çš„æ¡è³¼å–®**ï¼šæ›´æ–°æ‰€æœ‰æ¬„ä½ï¼ˆæ•¸é‡ã€äº¤æœŸã€ä¾›æ‡‰å•†ç­‰ï¼‰
- âœ… **æ–°å¢çš„æ¡è³¼å–®**ï¼šå»ºç«‹æ–°è¨˜éŒ„
- âš ï¸ **å·²åˆªé™¤çš„æ¡è³¼å–®**ï¼š**ä¸æœƒè‡ªå‹•åˆªé™¤**ï¼ˆä¿ç•™åœ¨è³‡æ–™åº«ä¸­ï¼‰

**æ›´æ–°çš„æ¬„ä½åŒ…æ‹¬**ï¼ˆç¬¬ 80-104 è¡Œï¼‰ï¼š
- ç‰©æ–™ç·¨è™Ÿ (`material_id`)
- ä¾›æ‡‰å•† (`supplier`)
- æ¡è³¼æ•¸é‡ (`ordered_quantity`)
- å¾…äº¤æ•¸é‡ (`outstanding_quantity`)
- å·²æ”¶æ•¸é‡ (`received_quantity`)
- æ–‡ä»¶æ—¥æœŸ (`document_date`)
- æ¡è³¼ç¾¤çµ„ (`purchase_group`) âœ… **æœƒæ›´æ–°ä¸¦è£œé›¶**
- å·¥å» ã€å„²å­˜åœ°é»ç­‰
- ç‹€æ…‹ (`status`)ï¼šæ ¹æ“šæ•¸é‡è‡ªå‹•è¨ˆç®—

**ç‹€æ…‹è¨ˆç®—é‚è¼¯**ï¼ˆç¬¬ 102-108 è¡Œï¼‰ï¼š
```python
if po.outstanding_quantity == 0:
    po.status = 'completed'      # å·²å®Œæˆ
elif po.received_quantity > 0:
    po.status = 'partial'        # éƒ¨åˆ†äº¤è²¨
else:
    po.status = 'pending'        # å¾…äº¤è²¨
```

---

#### 2. ç•¶ç‰©æ–™ä¸å­˜åœ¨æ–¼ materials è¡¨æ™‚

**ç›®å‰è™•ç†**ï¼ˆç¬¬ 110-118 è¡Œï¼‰ï¼š

```python
# ğŸ†• åŒæ­¥æ›´æ–°ç‰©æ–™è¡¨çš„æ¡è³¼äººå“¡ (ä½¿ç”¨æ¡è³¼ç¾¤çµ„)
if purchase_group is not None:
    material = Material.query.filter_by(material_id=material_id).first()
    if material:
        # material.buyer_id = purchase_group  # è¢«è¨»è§£æ‰
        pass  # âš ï¸ ç›®å‰å…ˆä¸æ›´æ–°
```

**ç›®å‰ç‹€æ…‹**ï¼š
- âŒ **ä¸æœƒå»ºç«‹æ–°ç‰©æ–™è¨˜éŒ„**
- âŒ **ä¸æœƒæ›´æ–° materials è¡¨çš„ buyer_id**ï¼ˆç¨‹å¼ç¢¼è¢«è¨»è§£ï¼‰
- âœ… **æ¡è³¼å–®ä»æœƒæ­£å¸¸åŒ¯å…¥åˆ° purchase_orders è¡¨**
- âš ï¸ **å¯èƒ½å°è‡´å¤–éµé—œè¯å•é¡Œ**ï¼ˆå¦‚æœ materials è¡¨æœ‰å¤–éµç´„æŸï¼‰

**æª¢æŸ¥å¤–éµç´„æŸ**ï¼š
```python
# database.py ç¬¬ 132 è¡Œ
material_id = db.Column(db.String(50), db.ForeignKey('materials.material_id'), ...)
```

âš ï¸ **æ½›åœ¨å•é¡Œ**ï¼šå¦‚æœ materials è¡¨ä¸­æ²’æœ‰å°æ‡‰ç‰©æ–™ï¼Œå¯èƒ½æœƒå› ç‚ºå¤–éµç´„æŸè€ŒåŒ¯å…¥å¤±æ•—ï¼

---

### äºŒã€`sync_buyer_from_purchase_orders.py` çš„è™•ç†é‚è¼¯

#### ç›®å‰çš„åŒ¹é…æ–¹å¼

**å®Œæ•´ç‰©æ–™è™Ÿç¢¼åŒ¹é…**ï¼ˆç¬¬ 43, 74 è¡Œï¼‰ï¼š
```python
material_id = str(row['ç‰©æ–™']).strip()  # 12ç¢¼å®Œæ•´ç‰©æ–™è™Ÿç¢¼
material = Material.query.filter_by(material_id=material_id).first()
```

**å•é¡Œ**ï¼š
- âŒ åªæœƒæ›´æ–°**å®Œå…¨ç›¸åŒ**çš„ç‰©æ–™è™Ÿç¢¼
- âŒ ä¸åŒç‰ˆæœ¬çš„ç‰©æ–™ï¼ˆå¦‚ `1234567890-01` vs `1234567890-02`ï¼‰ä¸æœƒå…±äº«æ¡è³¼äººå“¡

---

#### éœ€è¦æ”¹ç‚ºå‰10ç¢¼åŒ¹é…

**æ”¹é€²æ–¹æ¡ˆ**ï¼š
1. æå–ç‰©æ–™çš„å‰10ç¢¼ä½œç‚º `base_material_id`
2. æ›´æ–°æ‰€æœ‰å‰10ç¢¼ç›¸åŒçš„ç‰©æ–™
3. å¦‚æœç‰©æ–™ä¸å­˜åœ¨ï¼Œå»ºç«‹æ–°è¨˜éŒ„

**ç¯„ä¾‹**ï¼š
- Excel ä¸­æœ‰ç‰©æ–™ `1234567890-01`ï¼Œæ¡è³¼ç¾¤çµ„ `007`
- ç³»çµ±æœƒæ›´æ–°æ‰€æœ‰ `1234567890-*` çš„ç‰©æ–™çš„ buyer_id ç‚º `007`

---

## ğŸ”§ å»ºè­°æ”¹é€²æ–¹æ¡ˆ

### æ”¹é€² 1ï¼š`import_purchase_orders.py` - å•Ÿç”¨ç‰©æ–™åŒæ­¥

**ç›®çš„**ï¼šç•¶ç‰©æ–™ä¸å­˜åœ¨æ™‚ï¼Œè‡ªå‹•å»ºç«‹ç‰©æ–™è¨˜éŒ„

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬ 110-118 è¡Œ

**ä¿®æ”¹å‰**ï¼š
```python
if purchase_group is not None:
    material = Material.query.filter_by(material_id=material_id).first()
    if material:
        # material.buyer_id = purchase_group  # è¢«è¨»è§£
        pass  # ç›®å‰å…ˆä¸æ›´æ–°
```

**ä¿®æ”¹å¾Œ**ï¼š
```python
if purchase_group is not None:
    base_material_id = material_id[:10] if len(material_id) >= 10 else material_id
    material = Material.query.filter_by(material_id=material_id).first()
    
    if material:
        # æ›´æ–°ç¾æœ‰ç‰©æ–™çš„æ¡è³¼äººå“¡
        material.buyer_id = purchase_group
    else:
        # å»ºç«‹æ–°ç‰©æ–™è¨˜éŒ„
        new_material = Material(
            material_id=material_id,
            base_material_id=base_material_id,
            buyer_id=purchase_group,
            description=str(row['çŸ­æ–‡']) if pd.notna(row['çŸ­æ–‡']) else None
        )
        db.session.add(new_material)
```

---

### æ”¹é€² 2ï¼š`sync_buyer_from_purchase_orders.py` - å‰10ç¢¼åŒ¹é…

**ç›®çš„**ï¼šä¸€å€‹æ¡è³¼ç¾¤çµ„å¥—ç”¨åˆ°æ‰€æœ‰ç›¸åŒå‰10ç¢¼çš„ç‰©æ–™

**ç­–ç•¥é¸é …**ï¼š

#### é¸é … Aï¼šæ›´æ–°æ‰€æœ‰å‰10ç¢¼ç›¸åŒçš„ç‰©æ–™
```python
# ä½¿ç”¨å‰10ç¢¼æŸ¥è©¢æ‰€æœ‰ç›¸é—œç‰©æ–™
base_material_id = material_id[:10] if len(material_id) >= 10 else material_id
materials = Material.query.filter_by(base_material_id=base_material_id).all()

for material in materials:
    material.buyer_id = purchase_group
    update_count += 1
```

**å„ªé»**ï¼šä¸€æ¬¡æ›´æ–°æ‰€æœ‰ç‰ˆæœ¬
**ç¼ºé»**ï¼šå¦‚æœä¸åŒç‰ˆæœ¬æœ‰ä¸åŒæ¡è³¼äººå“¡ï¼Œæœƒè¢«è¦†è“‹

#### é¸é … Bï¼šåªæ›´æ–°å®Œå…¨åŒ¹é…çš„ç‰©æ–™ï¼Œä¸å­˜åœ¨å‰‡å»ºç«‹
```python
material = Material.query.filter_by(material_id=material_id).first()

if material:
    material.buyer_id = purchase_group
else:
    # å»ºç«‹æ–°ç‰©æ–™ï¼Œä½¿ç”¨å‰10ç¢¼ä½œç‚º base_material_id
    base_material_id = material_id[:10] if len(material_id) >= 10 else material_id
    new_material = Material(
        material_id=material_id,
        base_material_id=base_material_id,
        buyer_id=purchase_group
    )
    db.session.add(new_material)
```

**å„ªé»**ï¼šä¿ç•™ä¸åŒç‰ˆæœ¬çš„ç¨ç«‹æ€§
**ç¼ºé»**ï¼šéœ€è¦æ¯å€‹ç‰ˆæœ¬éƒ½åœ¨ Excel ä¸­å‡ºç¾

#### é¸é … Cï¼šæ··åˆç­–ç•¥ï¼ˆå»ºè­°ï¼‰
```python
# 1. å…ˆå˜—è©¦å®Œå…¨åŒ¹é…
material = Material.query.filter_by(material_id=material_id).first()

if material:
    material.buyer_id = purchase_group
    update_count += 1
else:
    # 2. å¦‚æœä¸å­˜åœ¨ï¼Œå»ºç«‹æ–°è¨˜éŒ„
    base_material_id = material_id[:10] if len(material_id) >= 10 else material_id
    new_material = Material(
        material_id=material_id,
        base_material_id=base_material_id,
        buyer_id=purchase_group
    )
    db.session.add(new_material)
    create_count += 1
    
    # 3. åŒæ™‚æ›´æ–°æ‰€æœ‰ç›¸åŒå‰10ç¢¼ä½† buyer_id ç‚ºç©ºçš„ç‰©æ–™
    related_materials = Material.query.filter(
        Material.base_material_id == base_material_id,
        Material.buyer_id.is_(None)
    ).all()
    
    for related in related_materials:
        related.buyer_id = purchase_group
        update_count += 1
```

**å„ªé»**ï¼š
- ä¿ç•™å·²è¨­å®šçš„æ¡è³¼äººå“¡
- è‡ªå‹•å¡«å……ç©ºç™½çš„æ¡è³¼äººå“¡
- å»ºç«‹ç¼ºå¤±çš„ç‰©æ–™è¨˜éŒ„

---

## ğŸ“Š è™•ç†æµç¨‹åœ–

### `import_purchase_orders.py` æµç¨‹

```
è®€å–å·²è¨‚æœªäº¤.XLSX
    â†“
éæ­·æ¯ä¸€ç­†æ¡è³¼å–®
    â†“
è™•ç† purchase_groupï¼ˆè£œé›¶åˆ°3ä½æ•¸ï¼‰
    â†“
æª¢æŸ¥æ¡è³¼å–®æ˜¯å¦å­˜åœ¨ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ æ›´æ–°ç¾æœ‰è¨˜éŒ„ï¼ˆæ•¸é‡ã€æ—¥æœŸã€ç‹€æ…‹ç­‰ï¼‰
    â””â”€ å¦ â†’ å»ºç«‹æ–°æ¡è³¼å–®è¨˜éŒ„
    â†“
æª¢æŸ¥ç‰©æ–™æ˜¯å¦å­˜åœ¨ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ [ç›®å‰ä¸è™•ç†] / [å»ºè­°ï¼šæ›´æ–° buyer_id]
    â””â”€ å¦ â†’ [ç›®å‰ä¸è™•ç†] / [å»ºè­°ï¼šå»ºç«‹æ–°ç‰©æ–™]
    â†“
æäº¤åˆ°è³‡æ–™åº«
```

### `sync_buyer_from_purchase_orders.py` æµç¨‹

```
è®€å–å·²è¨‚æœªäº¤.XLSX
    â†“
å»ºç«‹ç‰©æ–™â†’æ¡è³¼ç¾¤çµ„å°æ‡‰è¡¨
    â†“
éæ­·æ¯å€‹ç‰©æ–™
    â†“
[ç›®å‰] å®Œæ•´ç‰©æ–™è™Ÿç¢¼åŒ¹é…
[å»ºè­°] å‰10ç¢¼åŒ¹é…ç­–ç•¥
    â†“
æ›´æ–° materials.buyer_id
```

---

## âš ï¸ ç›®å‰å­˜åœ¨çš„å•é¡Œ

### å•é¡Œ 1ï¼šå¤–éµç´„æŸé¢¨éšª
- `purchase_orders.material_id` æœ‰å¤–éµç´„æŸåˆ° `materials.material_id`
- å¦‚æœç‰©æ–™ä¸å­˜åœ¨ï¼ŒåŒ¯å…¥å¯èƒ½å¤±æ•—

### å•é¡Œ 2ï¼šå·²åˆªé™¤çš„æ¡è³¼å–®ä¸æœƒç§»é™¤
- Excel ä¸­åˆªé™¤çš„æ¡è³¼å–®æœƒä¿ç•™åœ¨è³‡æ–™åº«ä¸­
- å¯èƒ½å°è‡´è³‡æ–™ä¸ä¸€è‡´

### å•é¡Œ 3ï¼šå‰10ç¢¼åŒ¹é…æœªå¯¦ç¾
- ä¸åŒç‰ˆæœ¬çš„ç‰©æ–™ç„¡æ³•å…±äº«æ¡è³¼äººå“¡è³‡è¨Š
- éœ€è¦æ‰‹å‹•ç¶­è­·æ¯å€‹ç‰ˆæœ¬

---

## ğŸ’¡ å»ºè­°çš„æ”¹é€²å„ªå…ˆé †åº

### å„ªå…ˆç´š 1ï¼šä¿®æ­£ `sync_buyer_from_purchase_orders.py`
- å¯¦ç¾å‰10ç¢¼åŒ¹é…
- è‡ªå‹•å»ºç«‹ç¼ºå¤±çš„ç‰©æ–™è¨˜éŒ„
- ä½¿ç”¨æ··åˆç­–ç•¥ï¼ˆé¸é … Cï¼‰

### å„ªå…ˆç´š 2ï¼šå•Ÿç”¨ `import_purchase_orders.py` çš„ç‰©æ–™åŒæ­¥
- å–æ¶ˆè¨»è§£ç‰©æ–™æ›´æ–°ç¨‹å¼ç¢¼
- æ–°å¢ç‰©æ–™å»ºç«‹é‚è¼¯
- é¿å…å¤–éµç´„æŸéŒ¯èª¤

### å„ªå…ˆç´š 3ï¼šæ–°å¢æ¸…ç†æ©Ÿåˆ¶ï¼ˆå¯é¸ï¼‰
- å®šæœŸæ¸…ç†å·²å®Œæˆä¸”éæœŸçš„æ¡è³¼å–®
- æˆ–æ–°å¢ã€Œè»Ÿåˆªé™¤ã€æ¨™è¨˜

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡Œå‹•

1. **ç¢ºèªéœ€æ±‚**ï¼š
   - æ˜¯å¦éœ€è¦å‰10ç¢¼åŒ¹é…ï¼Ÿ
   - æ¡ç”¨å“ªç¨®åŒ¹é…ç­–ç•¥ï¼ˆA/B/Cï¼‰ï¼Ÿ
   - æ˜¯å¦éœ€è¦è‡ªå‹•å»ºç«‹ç‰©æ–™ï¼Ÿ

2. **ä¿®æ”¹è…³æœ¬**ï¼š
   - ä¿®æ”¹ `sync_buyer_from_purchase_orders.py`
   - ä¿®æ”¹ `import_purchase_orders.py`

3. **æ¸¬è©¦é©—è­‰**ï¼š
   - å‚™ä»½è³‡æ–™åº«
   - åŸ·è¡Œæ¸¬è©¦åŒ¯å…¥
   - é©—è­‰çµæœ

---

## ğŸ“ éœ€è¦ç¢ºèªçš„å•é¡Œ

1. **å‰10ç¢¼åŒ¹é…ç­–ç•¥**ï¼šä½ å¸Œæœ›ä½¿ç”¨å“ªç¨®ç­–ç•¥ï¼ˆA/B/Cï¼‰ï¼Ÿ
2. **ç‰©æ–™å»ºç«‹**ï¼šæ˜¯å¦éœ€è¦è‡ªå‹•å»ºç«‹ä¸å­˜åœ¨çš„ç‰©æ–™ï¼Ÿ
3. **æ¡è³¼å–®æ¸…ç†**ï¼šæ˜¯å¦éœ€è¦æ¸…ç†å·²åˆªé™¤çš„æ¡è³¼å–®ï¼Ÿ
