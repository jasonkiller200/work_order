# 快速修復：API 500錯誤

## 問題
API 返回 500 錯誤，錯誤訊息：`NameError: name 'demand_details_map' is not defined`

## 原因
在實作30日內缺料檢查功能時，`_build_main_dataframe` 方法中使用了 `demand_details_map` 參數，但函數定義和呼叫時沒有傳入這個參數。

## 修復內容

### 修改的檔案：`app/services/data_service.py`

#### 1. 修改函數定義（第199行）
**修改前：**
```python
def _build_main_dataframe(df_total_demand, df_inventory, df_total_on_order, df_demand, material_buyer_map=None):
```

**修改後：**
```python
def _build_main_dataframe(df_total_demand, df_inventory, df_total_on_order, df_demand, material_buyer_map=None, demand_details_map=None):
```

#### 2. 修改函數呼叫（第111-118行）
**修改前：**
```python
df_main = DataService._build_main_dataframe(
    df_total_demand, df_inventory, df_total_on_order, df_demand, material_buyer_map
)

df_finished_dashboard = DataService._build_main_dataframe(
    df_total_finished_demand, df_inventory, df_total_on_order, df_finished_demand, material_buyer_map
)
```

**修改後：**
```python
df_main = DataService._build_main_dataframe(
    df_total_demand, df_inventory, df_total_on_order, df_demand, material_buyer_map, demand_details_map
)

df_finished_dashboard = DataService._build_main_dataframe(
    df_total_finished_demand, df_inventory, df_total_on_order, df_finished_demand, material_buyer_map, finished_demand_details_map
)
```

## 重新啟動步驟

1. **停止Flask應用**
   ```powershell
   Get-Process -Name python | Where-Object {$_.Path -like "*order*"} | Stop-Process -Force
   ```

2. **重新啟動應用**
   ```powershell
   cd C:\app\order
   .\start_order_server.ps1
   ```

3. **確認啟動成功**
   - 查看終端機輸出
   - 確認顯示 "Serving on http://0.0.0.0:5002"
   - 確認沒有錯誤訊息

4. **測試API**
   - 開啟瀏覽器
   - 訪問 http://192.168.6.119:5002/procurement
   - 確認儀表板正常載入
   - 檢查是否有淺綠色背景的項目（30日內缺料）

## 驗證

- ✅ Python語法檢查通過
- ✅ 修復了參數傳遞問題
- ⏳ 等待重新啟動應用測試

## 修復時間
2025-11-30 12:49
