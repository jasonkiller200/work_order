# 錯誤修復說明

## 修復日期：2025-11-30

## 修復的問題

### 1. favicon.ico 404 錯誤
**問題描述：**
- 瀏覽器請求 `/favicon.ico` 時返回 404 錯誤
- 瀏覽器控制台顯示：`GET http://192.168.6.119:5002/favicon.ico 404 (NOT FOUND)`

**解決方案：**
1. 建立 SVG 格式的 favicon 圖示（`app/static/favicon.svg`）
2. 在所有 HTML 頁面的 `<head>` 區塊加入 favicon 連結：
   ```html
   <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
   ```

**修改的檔案：**
- ✅ 新增：`app/static/favicon.svg`
- ✅ 修改：`app/views/procurement.html`
- ✅ 修改：`app/views/order_query.html`
- ✅ 修改：`app/views/admin_dashboard.html`

---

### 2. 物料詳情 API 404 錯誤

**問題描述：**
- 點擊物料編號時，API 返回 404 錯誤
- 錯誤訊息：`找不到該物料`
- JavaScript 錯誤：`Cannot read properties of undefined (reading 'unrestricted')`

**原因分析：**
1. **後端問題**：API 只在儀表板資料（已篩選有缺料的物料）中查找物料
   - 儀表板只包含有缺料的物料
   - 但使用者可能點擊沒有缺料的物料（例如在其他頁面）
   - 導致找不到物料資訊

2. **前端問題**：沒有傳遞 `dashboard_type` 參數
   - 成品儀表板和主儀表板使用不同的資料來源
   - 前端未正確傳遞當前儀表板類型
   - 導致 API 在錯誤的資料集中查找

**解決方案：**

#### 後端修改（`app/controllers/api_controller.py`）

**修改前的邏輯：**
```python
# 只在儀表板資料中查找（已篩選）
materials_data = current_data.get("materials_dashboard", [])
material_dao = MaterialDAO(materials_data)
material_info = material_dao.get_by_id(material_id)
```

**修改後的邏輯：**
```python
# 1. 先從完整庫存資料中查找
inventory_data = current_data.get("inventory_data", [])
material_info = None

for item in inventory_data:
    if item.get('物料') == material_id:
        material_info = item
        break

# 2. 如果找不到，再從儀表板資料查找（備用）
if not material_info:
    materials_data = current_data.get("materials_dashboard", [])
    for item in materials_data:
        if item.get('物料') == material_id:
            material_info = item
            break
```

**優點：**
- 可以查詢所有物料，不限於有缺料的物料
- 提供備用查詢機制，確保資料完整性
- 直接處理替代品查詢，不依賴 MaterialDAO

#### 前端修改（`app/static/js/main.js`）

**修改前：**
```javascript
fetch(`/api/material/${materialId}/details`)
```

**修改後：**
```javascript
const dashboardType = currentDashboardType;
fetch(`/api/material/${materialId}/details?type=${dashboardType}`)
```

**改善錯誤處理：**
```javascript
.then(response => {
    if (!response.ok) {
        return response.json().then(err => Promise.reject(err));
    }
    return response.json();
})
.then(data => {
    if (data.error) {
        throw new Error(data.error);
    }
    // 正常處理資料...
})
.catch(error => {
    // 顯示友善的錯誤訊息
    const errorMsg = error.error || error.message || '未知錯誤';
    document.getElementById('unrestricted-stock').textContent = '-';
    // ...其他錯誤處理
});
```

**修改的檔案：**
- ✅ 修改：`app/controllers/api_controller.py` - 改善物料查詢邏輯
- ✅ 修改：`app/static/js/main.js` - 加入 dashboard_type 參數和錯誤處理

---

## 測試建議

### 測試 favicon 修復
1. ✅ 開啟任一頁面
2. ✅ 檢查瀏覽器分頁標籤是否顯示藍色 "P" 圖示
3. ✅ 開啟瀏覽器開發者工具，確認 favicon.svg 回傳 200 狀態碼

### 測試物料詳情修復

#### 測試場景 1：主儀表板
1. ✅ 開啟採購儀表板（主儀表板）
2. ✅ 點擊任一物料編號（藍色底線連結）
3. ✅ 確認彈出視窗正常顯示：
   - 庫存總覽有數字
   - 需求訂單列表（如果有）
   - 可替代版本（如果有）

#### 測試場景 2：成品儀表板
1. ✅ 切換到「成品儀表板」分頁
2. ✅ 點擊任一物料編號
3. ✅ 確認彈出視窗正常顯示對應的成品資料

#### 測試場景 3：沒有缺料的物料
1. ✅ 如果可以，手動在 URL 輸入：
   ```
   http://192.168.6.119:5002/api/material/101000286200/details?type=main
   ```
2. ✅ 確認回傳資料而不是 404 錯誤

#### 測試場景 4：錯誤處理
1. ✅ 點擊一個不存在的物料（如果可測試）
2. ✅ 確認顯示友善的錯誤訊息，而不是 JavaScript 錯誤

---

## 需要重新啟動

⚠️ **重要：** 由於修改了後端 API 程式碼，**必須重新啟動 Flask 應用**才能生效。

### 重新啟動步驟：
```powershell
# 停止現有的 Flask 程序
Get-Process -Name python | Where-Object {$_.Path -like "*order*"} | Stop-Process -Force

# 重新啟動應用
cd C:\app\order
.\start_order_server.ps1
```

或者手動：
1. 關閉目前運行的 Flask 應用
2. 重新執行啟動腳本

---

## 技術細節

### 資料流程改善

**修改前：**
```
點擊物料 → API查詢儀表板資料（已篩選） → 找不到 → 404錯誤
```

**修改後：**
```
點擊物料 → 傳遞dashboard_type參數 
         → API先查完整庫存資料 
         → 找不到時再查儀表板資料（備用）
         → 返回物料資訊或友善錯誤
```

### API 參數說明

**GET `/api/material/<material_id>/details`**

**查詢參數：**
- `type` (可選) - 儀表板類型
  - `main` - 主儀表板（預設）
  - `finished` - 成品儀表板

**回應格式：**
```json
{
  "stock_summary": {
    "unrestricted": 100,
    "inspection": 0,
    "on_order": 50
  },
  "demand_details": [...],
  "substitute_inventory": [...]
}
```

**錯誤回應：**
```json
{
  "error": "找不到該物料"
}
```

---

## 相關文件

- 採購儀錶板更新說明.md - 主要功能更新說明
- 目錄結構說明.md - 系統架構說明

---

## 後續改進建議

1. **效能優化**：
   - 考慮為 inventory_data 建立索引（字典結構）加速查詢
   - 避免每次都遍歷整個陣列

2. **快取機制**：
   - 前端可以快取已查詢過的物料詳情
   - 減少重複的 API 請求

3. **錯誤監控**：
   - 加入錯誤追蹤系統（如 Sentry）
   - 自動記錄和通知 API 錯誤

4. **使用者體驗**：
   - 加入載入動畫
   - 改善錯誤訊息顯示方式（toast 通知）
