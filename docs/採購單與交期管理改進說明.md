# 採購單與交期管理改進說明

## 📅 更新日期：2025年12月15日

---

## 🎯 改進總覽

本次更新主要改進了三個核心功能：

1. ✅ **已結案採購單不再顯示**
2. ✅ **交期自動選擇優先邏輯**
3. ✅ **過期交期提醒與自動清理**

---

## 📋 詳細改進內容

### 1. 已結案採購單過濾 🔍

#### 問題
- 之前所有採購單都會顯示，包含已完成和已取消的
- 造成列表混亂，難以找到需要追蹤的採購單

#### 解決方案
**API 改進**：`/api/purchase_orders/<material_id>`

```python
# ✅ 只查詢未結案的採購單
purchase_orders = PurchaseOrder.query.filter(
    PurchaseOrder.material_id == material_id,
    PurchaseOrder.status.notin_(['completed', 'cancelled'])
).order_by(PurchaseOrder.original_delivery_date).all()
```

#### 效果
- ✅ 採購單列表只顯示：`pending`、`partial`、`planned`、`updated` 狀態
- ✅ 已完成 (`completed`) 和已取消 (`cancelled`) 的採購單不顯示
- ✅ 使用者更容易聚焦在需要追蹤的採購單

---

### 2. 交期自動選擇優先邏輯 🎯

#### 改進前
- 只從手動維護的交期中選擇
- 無法自動使用採購單的交期
- 過期交期會一直保留

#### 改進後

**優先順序**：

```
1️⃣ 未結案採購單的交期（最優先）
   └─ 選擇交期最早的未結案採購單

2️⃣ 手動維護的未過期交期
   └─ 選擇距今最近的未過期交期

3️⃣ 昨天過期的交期（保留1天提醒）
   └─ 標記為 overdue，提示使用者更新

4️⃣ 過期超過1天的交期
   └─ 自動隱藏（不顯示）
```

#### API 改進：`/api/delivery/<material_id>`

**回傳資料結構**：

```json
{
  "delivery": {
    "source": "purchase_order",
    "po_number": "1100079310-10",
    "expected_date": "2025-12-18",
    "quantity": 8,
    "supplier": "崧偉科技",
    "status": "partial"
  },
  "po_delivery": {...},      // 採購單交期（如有）
  "manual_delivery": {...},  // 手動維護交期（如有）
  "history": [...]           // 完整歷史記錄
}
```

#### 效果
- ✅ 自動優先使用採購單交期
- ✅ 採購單結案後，自動切換到下一筆採購單
- ✅ 沒有採購單時，才使用手動維護的交期

---

### 3. 過期交期提醒與自動清理 ⚠️

#### 功能特色

##### A. 過期檢測機制

**時間判斷**：
- ✅ **今天及以後** → 正常顯示（藍色邊框）
- ⚠️ **昨天過期** → 保留1天，顯示警告（橙色邊框）
- 🗑️ **過期超過1天** → 自動不顯示

##### B. 視覺提示

**過期警告框**：

```html
⚠️ 交期已過期（2025-12-14），請更新或清除
[🗑️ 清除過期交期]
```

**歷史記錄標示**：
- 未過期：藍色邊框 `#2196f3`
- 已過期：橙色邊框 `#ff9800` + ⚠️ 標記

##### C. 清除功能

**手動清除**：
- 點擊「🗑️ 清除過期交期」按鈕
- 系統會移除所有過期的交期記錄
- 自動載入下一筆有效交期（如有）

**API 端點**：`POST /api/delivery/<material_id>/clear_overdue`

**處理邏輯**：
```python
# 只保留今天及之後的交期
if delivery_date >= today:
    updated_schedules.append(schedule)
else:
    removed_count += 1
```

---

## 🔄 完整工作流程範例

### 情境：物料 10100001 的交期管理

#### 初始狀態
- 採購單 A：交期 2025-12-20，未交 50 件，狀態 `pending`
- 採購單 B：交期 2025-12-25，未交 30 件，狀態 `pending`
- 手動交期：2025-12-18，100 件

**系統顯示**：
- 採購單 A 的交期：2025-12-20（優先）
- 來源：採購單 1100079310-10

---

#### 採購單 A 結案後

採購單 A 狀態變為 `completed` → 從列表中移除

**系統自動切換**：
- 採購單 B 的交期：2025-12-25
- 來源：採購單 1100085315-10

---

#### 所有採購單都結案

採購單 A、B 都是 `completed`

**系統自動切換**：
- 手動交期：2025-12-18，100 件
- 來源：手動維護

---

#### 手動交期過期

今天是 2025-12-19，手動交期 2025-12-18 過期

**第1天（昨天過期）**：
- ⚠️ 顯示警告：「交期已過期，請更新或清除」
- 提供清除按鈕
- 橙色邊框標示

**第2天（過期超過1天）**：
- 🗑️ 自動不顯示該交期
- 使用下一筆有效交期（如有）

---

## 📊 狀態說明

### 採購單狀態

| 狀態 | 中文 | 說明 | 是否顯示 |
|------|------|------|---------|
| `pending` | 待交貨 | 已下單，等待交貨 | ✅ 顯示 |
| `partial` | 部分交貨 | 已到部分，還有未交 | ✅ 顯示 |
| `planned` | 計畫中 | 預計採購（手動建立） | ✅ 顯示 |
| `updated` | 已更新 | 交期已更新 | ✅ 顯示 |
| `completed` | 已完成 | 全部到貨 | ❌ 不顯示 |
| `cancelled` | 已取消 | 訂單取消 | ❌ 不顯示 |

### 交期狀態

| 狀態 | 說明 | 顯示方式 |
|------|------|---------|
| 正常 | 今天及以後 | 藍色邊框，正常顯示 |
| `overdue` | 昨天過期 | 橙色邊框 + 警告提示 |
| 超期 | 過期超過1天 | 不顯示（自動隱藏） |

---

## 📝 無採購單介面優化

### 4. 無採購單友善提示 💡

#### 問題
- 有些物料無法從「已訂未交.xlsx」撈到採購單資訊
- 採購人員不確定沒有採購單時該如何操作
- 介面缺少明確的指引

#### 解決方案

##### A. 友善的空狀態提示

**採購單表格為空時**：
```
┌─────────────────────────────────────┐
│            📋                       │
│   此物料目前無採購單記錄              │
│                                     │
│ 您可以在下方「📅 交期維護」中        │
│ 直接填寫預計交期                     │
│                                     │
│ ※ 採購單號可留空，或填寫預計採購單號  │
│   （例如：預採-20251215-001）       │
└─────────────────────────────────────┘
```

##### B. 交期表單上方的提示框

**無採購單時自動顯示**：
```
┌─────────────────────────────────────┐
│ 💡 此物料目前無採購單記錄             │
│                                     │
│ 您可以直接填寫預計交期，系統會自動記錄： │
│ • 採購單號可留空，或填寫預計單號       │
│   （例如：預採-20251215-001）       │
│ • 供應商可填寫預計供應商名稱          │
│ • 之後有正式採購單時，可隨時更新       │
└─────────────────────────────────────┘
```

##### C. 欄位標籤優化

**採購單號欄位**：
```html
採購單號 (選填)
※ 無採購單可留空或填寫預計單號
[輸入框：例如：預採-20251215-001 或留空]
```

**供應商欄位**：
```html
供應商 (選填)
※ 可填寫預計供應商
[輸入框：供應商名稱或預計供應商]
```

**採購單選擇器**：
```html
關聯採購單 (可選)
※ 可直接新建交期，不需關聯採購單
[下拉選單：-- 新建交期記錄 (不關聯採購單) --]
```

#### 實作細節

**前端實作**：`app/static/js/main.js`

```javascript
// 無採購單時的友善提示
if (data.length === 0) {
    // 1. 表格顯示友善訊息
    poTbody.innerHTML = `
        <div style="color: var(--pico-muted-color);">
            <div style="font-size: 2em;">📋</div>
            <div>此物料目前無採購單記錄</div>
            <div>您可以在下方「📅 交期維護」中直接填寫預計交期</div>
        </div>
    `;
    
    // 2. 加入表單上方提示
    addNoPurchaseOrderHint();
}

// 新增提示函數
function addNoPurchaseOrderHint() {
    const hint = document.createElement('div');
    hint.innerHTML = `
        💡 此物料目前無採購單記錄
        您可以直接填寫預計交期，系統會自動記錄：
        • 採購單號可留空或填寫預計單號
        • 供應商可填寫預計供應商名稱
        • 之後有正式採購單時，可隨時更新
    `;
    deliveryFormSection.insertBefore(hint, formTitle.nextSibling);
}
```

**HTML 優化**：`app/views/procurement.html`

- ✅ 採購單號標籤加入「(選填)」和小字提示
- ✅ 供應商標籤加入「(選填)」和小字提示
- ✅ 採購單選擇器加入說明文字
- ✅ Placeholder 文字更友善

#### 效果

**使用者體驗**：
- ✅ 清楚知道沒有採購單時該怎麼做
- ✅ 了解可以填寫預計採購單號
- ✅ 知道之後可以更新為正式採購單
- ✅ 減少操作疑慮，提高填寫意願

**操作流程**：
```
1. 開啟物料詳情
2. 看到「無採購單」提示 💡
3. 直接在交期維護表單填寫：
   - 預計到貨日期：2025-12-25
   - 採購數量：100
   - 採購單號：預採-20251215-001（或留空）
   - 供應商：預計供應商A（或留空）
4. 點擊「💾 儲存交期」
5. 系統記錄成功 ✅
```

**之後有正式採購單時**：
```
1. 採購單匯入系統
2. 系統自動優先使用採購單交期
3. 手動交期作為備用
4. 可以隨時更新手動交期
```

---

## 🎨 使用者介面改進

### 交期來源提示

**有採購單時**：
```
ℹ️ 目前使用採購單交期：1100079310-10
   （2025-12-18，8 件）
```

**過期警告時**：
```
⚠️ 交期已過期（2025-12-14），請更新或清除
   [🗑️ 清除過期交期]
```

### 採購單表格

```
採購單號          供應商          數量              交期        狀態      操作
1100079310-10  崧偉科技  訂購: 20 未交: 8   2025-12-18  部分交貨  [帶入]
1100085315-10  崧偉科技  訂購: 20 未交: 20  2025-12-25  待交貨    [帶入]
```

**狀態顏色**：
- 🟠 待交貨 (`pending`)
- 🔵 部分交貨 (`partial`)
- 🟢 已更新 (`updated`)
- 🟣 計畫中 (`planned`)

---

## 🔧 技術實作

### 後端改進

**檔案**：`app/controllers/api_controller.py`

1. **過濾已結案採購單**（第 776-781 行）
2. **改進交期選擇邏輯**（第 523-633 行）
3. **新增清除過期交期 API**（第 708-762 行）

### 前端改進

**檔案**：`app/static/js/delivery-helper.js`

1. **過期交期檢測與提示**（第 4-100 行）
2. **清除過期交期功能**（第 330-360 行）

**檔案**：`app/static/js/main.js`

1. **採購單狀態映射改進**（第 1431-1470 行）
2. **過濾邏輯調整**（第 1476-1490 行）

---

## 📱 使用指南

### 採購人員操作流程

#### 1. 查看物料詳情
- 點擊物料編號
- 查看「採購單資訊」區塊
- ✅ 只顯示未結案的採購單

#### 2. 維護交期
- 系統自動帶入採購單交期（如有）
- 可以手動調整或新增交期
- 保存後自動更新儀錶板

#### 3. 處理過期交期
- 看到橙色警告框 → 交期過期
- 選擇：
  - 更新交期 → 填寫新的日期和數量
  - 清除過期 → 點擊「清除過期交期」

#### 4. 採購單結案後
- 系統自動切換到下一筆採購單交期
- 或使用手動維護的交期
- 無需手動調整

---

## ✅ 測試建議

### 測試案例 1：已結案採購單過濾

**步驟**：
1. 開啟物料詳情
2. 查看採購單列表

**預期結果**：
- ✅ 只顯示 `pending`、`partial` 等未結案狀態
- ✅ `completed`、`cancelled` 不顯示

---

### 測試案例 2：交期自動切換

**步驟**：
1. 物料有採購單 A（2025-12-20）和 B（2025-12-25）
2. 採購單 A 結案
3. 重新載入物料詳情

**預期結果**：
- ✅ 自動顯示採購單 B 的交期
- ✅ 來源提示：「目前使用採購單交期：B」

---

### 測試案例 3：過期交期處理

**步驟**：
1. 手動交期設為昨天
2. 開啟物料詳情
3. 點擊「清除過期交期」

**預期結果**：
- ⚠️ 顯示橙色警告框
- ✅ 清除後，交期欄位清空
- ✅ Toast 提示：「已清除過期交期」

---

## 🎯 效益評估

### 採購人員
- ⏱️ **節省時間**：不用手動過濾已結案採購單
- 👁️ **視覺清晰**：列表更簡潔，容易找到重點
- 🔔 **即時提醒**：過期交期自動警告

### 系統管理
- 🗄️ **資料整潔**：過期交期自動清理
- 🔄 **邏輯優化**：自動選擇最合適的交期
- 📊 **統計準確**：儀錶板數據更精確

---

## 🚀 未來規劃

### 可能的擴充功能

1. **批次清理過期交期**
   - 定時任務（每天凌晨）
   - 自動清理超過7天的過期交期

2. **交期變更通知**
   - 採購單交期改變時發送通知
   - Email 或系統訊息提醒

3. **交期統計分析**
   - 準時到貨率
   - 平均延遲天數
   - 供應商績效評分

4. **智慧交期建議**
   - 根據歷史數據預測交期
   - AI 推薦最佳下單時間

---

## 📞 常見問題

### Q1: 為什麼看不到之前的採購單？
**A:** 已完成或已取消的採購單會自動隱藏。如需查看歷史記錄，請聯繫系統管理員。

### Q2: 過期交期什麼時候會消失？
**A:** 過期1天後會自動不顯示，但仍保留在歷史記錄中。可以手動清除。

### Q3: 採購單交期和手動交期衝突時，用哪個？
**A:** 優先使用未結案採購單的交期。如果沒有有效的採購單，才使用手動維護的交期。

### Q4: 可以恢復已清除的過期交期嗎？
**A:** 清除後無法直接恢復，但歷史記錄中仍有資料。如需恢復，請聯繫系統管理員。

---

## 📝 更新日誌

### v2.5.0 - 2025-12-15

#### 新增功能
- ✨ 已結案採購單自動過濾
- ✨ 交期自動選擇優先邏輯
- ✨ 過期交期提醒與清除功能
- ✨ 交期來源提示（採購單 vs 手動）

#### 改進
- 🎨 採購單狀態顏色優化
- 🔧 交期選擇邏輯重構
- 📊 過期交期視覺標示

#### 修復
- 🐛 修復過期交期一直顯示的問題
- 🐛 修復採購單結案後交期不更新

---

**文件版本**：1.0  
**最後更新**：2025-12-15  
**維護人員**：系統開發團隊
