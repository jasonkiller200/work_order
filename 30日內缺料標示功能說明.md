# 30日內缺料標示功能說明

## 更新日期：2025-11-30

## 功能概述

在採購儀錶板中，自動標示**未來30日內會發生缺料**的物料項目，以**淺綠色背景**突出顯示，幫助採購人員優先處理緊急缺料項目。

---

## 視覺效果

### 標示規則

| 狀態 | 背景顏色 | 說明 |
|------|---------|------|
| 一般物料 | 白色 | 30日內不會缺料的物料 |
| **30日內缺料** | **淺綠色 (#e8f5e9)** | 未來30日內有需求且會缺料的物料 |
| 懸停效果 | 深綠色 (#c8e6c9) | 滑鼠懸停時顏色稍深 |

### 範例

```
物料編號    物料說明         採購人員  總需求  庫存  ...
────────────────────────────────────────────────────
10100001    普通物料A         王小明    100    150   ✓ (白色)
10100002    緊急物料B         李小華    200     50   ⚠️ (淺綠色) ← 30日內缺料
10100003    正常物料C         張三      80     100   ✓ (白色)
10100004    急需物料D         王小明    150     80   ⚠️ (淺綠色) ← 30日內缺料
```

---

## 計算邏輯

### 判斷標準

物料會被標示為「30日內缺料」需同時滿足：

1. ✅ 有訂單需求（未結數量 > 0）
2. ✅ 需求日期在未來30日內
3. ✅ 按時間順序計算，扣除需求後庫存會變成負數

### 計算流程

```python
1. 取得今天日期 + 30天 = 截止日期
2. 篩選該物料在截止日期前的所有需求
3. 按需求日期排序（由近到遠）
4. 計算可用庫存 = 未限制庫存 + 品質檢驗中
5. 模擬庫存消耗：
   for 每筆需求 in 30日內需求:
       可用庫存 -= 需求數量
       if 可用庫存 < 0:
           標記為「30日內缺料」
           break
```

### 範例計算

**物料A的情況：**
- 可用庫存：100
- 未來30日需求：
  - 12/05：需求 40 → 剩餘 60 ✓
  - 12/15：需求 50 → 剩餘 10 ✓
  - 12/25：需求 20 → 剩餘 -10 ❌ **缺料！**
- **結果**：標示為淺綠色

**物料B的情況：**
- 可用庫存：200
- 未來30日需求：
  - 12/10：需求 50 → 剩餘 150 ✓
  - 12/20：需求 80 → 剩餘 70 ✓
- **結果**：不標示（白色）

---

## 實作細節

### 後端修改

#### 檔案：`app/services/data_service.py`

**1. 在建立主資料表時加入30日檢查**

```python
# 計算未來30日內是否有需求缺料
df_main['shortage_within_30_days'] = DataService._check_shortage_within_days(
    df_main, demand_details_map, days=30
)
```

**2. 新增檢查方法**

```python
@staticmethod
def _check_shortage_within_days(df_materials, demand_details_map, days=30):
    '''檢查物料是否在未來指定天數內有需求缺料'''
    from datetime import datetime, timedelta
    
    cutoff_date = pd.Timestamp(datetime.now() + timedelta(days=days))
    shortage_flags = []
    
    for _, material in df_materials.iterrows():
        material_id = material['物料']
        available_stock = material.get('unrestricted_stock', 0) + material.get('inspection_stock', 0)
        
        # 取得該物料的需求詳情
        demand_details = demand_details_map.get(material_id, [])
        
        # 過濾出指定天數內的需求
        within_days_demands = [
            d for d in demand_details 
            if pd.notna(d.get('需求日期')) and d.get('需求日期') <= cutoff_date
        ]
        
        # 按日期排序
        within_days_demands.sort(key=lambda x: x.get('需求日期', pd.Timestamp.max))
        
        # 計算是否會缺料
        running_stock = available_stock
        has_shortage = False
        
        for demand in within_days_demands:
            demand_qty = demand.get('未結數量 (EINHEIT)', 0)
            running_stock -= demand_qty
            if running_stock < 0:
                has_shortage = True
                break
        
        shortage_flags.append(has_shortage)
    
    return pd.Series(shortage_flags, index=df_materials.index)
```

**資料結構：**
```json
{
  "物料": "10100001",
  "物料說明": "某物料",
  "total_demand": 100,
  "unrestricted_stock": 50,
  "shortage_within_30_days": true,  ← 新增欄位
  ...
}
```

---

### 前端修改

#### 檔案：`app/static/js/main.js`

**渲染表格時根據標記加入CSS類別**

```javascript
paginatedData.forEach(m => {
    const buyer = m['採購人員'] || '-';
    
    // 檢查是否在30日內有缺料需求
    const shortage30Days = m.shortage_within_30_days || false;
    const rowClass = shortage30Days ? ' class="shortage-30-days"' : '';
    
    tableHTML += `
        <tr${rowClass}>
            <td><span class="material-link">${m['物料']}</span></td>
            ...
        </tr>
    `;
});
```

---

### CSS樣式

#### 檔案：`app/static/css/style.css`

```css
/* 30日內缺料項目標示 */
.shortage-30-days {
    background-color: #e8f5e9 !important; /* 淺綠色背景 */
}

.shortage-30-days:hover {
    background-color: #c8e6c9 !important; /* 懸停時稍深的綠色 */
}
```

**顏色選擇理由：**
- **#e8f5e9**：Material Design 的 Green 50，淺綠色，代表「注意但不緊急」
- **#c8e6c9**：Material Design 的 Green 100，懸停時稍深，提供視覺反饋

---

## 使用場景

### 場景一：採購人員日常檢查

1. 開啟採購儀錶板
2. 掃視表格，**淺綠色背景**的項目為30日內會缺料
3. 優先處理這些項目的採購
4. 點擊物料編號查看詳細需求日期

### 場景二：按緊急程度排序

視覺優先級（由高到低）：
1. 🟩 **淺綠色** - 30日內會缺料（最緊急）
2. ⚪ 白色 - 目前有缺料但30日內不會發生
3. ⚪ 白色 - 未來可能缺料但不在30日內

### 場景三：配合其他功能

- **排序**：可以按「預計缺料」欄位排序，配合綠色標示找出最緊急項目
- **篩選**：搜尋特定物料後，仍會保留綠色標示
- **採購人員篩選**：按採購人員篩選，查看自己負責的緊急項目

---

## 與其他標示的區別

| 功能 | 顏色/樣式 | 意義 | 觸發條件 |
|------|----------|------|----------|
| **30日內缺料** | 淺綠色背景 | 緊急需要採購 | 30日內會缺料 |
| 目前缺料 | 紅色數字（粗體） | 現在就缺料 | 總需求 > 庫存 |
| 預計缺料 | 紅色數字（粗體） | 未來會缺料 | 總需求 > (庫存 + 已訂未入) |
| 缺料點位 | 表格列底色（黃色） | 需求詳情中的缺料點 | 詳情視窗中使用 |

**優先處理順序建議：**
```
1. 淺綠色 + 目前缺料數字 > 0  → 最緊急！立即採購
2. 淺綠色 + 預計缺料數字 > 0  → 緊急，盡快採購
3. 白色 + 預計缺料數字 > 0    → 一般，正常處理
```

---

## 效能考量

### 計算時機
- ✅ 系統啟動時計算一次
- ✅ 重新載入資料時重新計算
- ✅ 不會在每次瀏覽時重新計算（使用快取資料）

### 效能影響
- 每個物料需要遍歷其需求詳情（平均 5-10 筆）
- 總計算時間：約 1-2 秒（1000 個物料）
- 對頁面載入速度幾乎無影響（已包含在資料處理中）

### 最佳化
- 使用 pandas 向量化操作
- 需求已按日期預先排序
- 一旦發現缺料就停止計算

---

## 測試建議

### 測試案例

**測試1：正常物料（不標示）**
- 物料：有充足庫存
- 30日內需求：總數小於庫存
- 預期結果：白色背景

**測試2：30日內缺料（標示）**
- 物料：庫存不足
- 30日內有需求且會缺料
- 預期結果：淺綠色背景

**測試3：31日後才缺料（不標示）**
- 物料：30日內庫存足夠
- 第31日才會缺料
- 預期結果：白色背景

**測試4：邊界條件**
- 物料：剛好第30天會缺料
- 預期結果：淺綠色背景

### 驗證步驟

1. **重新啟動應用**
   ```powershell
   cd C:\app\order
   # 重新啟動 Flask 應用
   ```

2. **開啟採購儀錶板**
   - 觀察是否有淺綠色背景的項目
   - 檢查顏色是否正確

3. **點擊淺綠色項目的物料編號**
   - 查看需求詳情
   - 確認在30日內確實會缺料

4. **測試排序和篩選**
   - 排序後綠色標示應保留
   - 篩選後綠色標示應保留

---

## 自訂調整

### 修改天數（例如改為15日或60日）

在 `app/services/data_service.py` 中修改：

```python
# 將 30 改為想要的天數
df_main['shortage_within_30_days'] = DataService._check_shortage_within_days(
    df_main, demand_details_map, days=15  # 改為15日
)
```

### 修改背景顏色

在 `app/static/css/style.css` 中修改：

```css
.shortage-30-days {
    background-color: #fff9c4 !important; /* 改為淺黃色 */
}

.shortage-30-days:hover {
    background-color: #fff59d !important; /* 懸停時的黃色 */
}
```

**常用顏色建議：**
- 淺綠色：`#e8f5e9` （預設，表示注意）
- 淺黃色：`#fff9c4` （警告）
- 淺橙色：`#ffe0b2` （較緊急）
- 淺紅色：`#ffcdd2` （非常緊急）

---

## 注意事項

1. **需求日期準確性**：
   - 依賴訂單需求日期的準確性
   - 如果需求日期不正確，標示也會不準確

2. **已訂未入不計入**：
   - 計算時只考慮「未限制庫存」和「品質檢驗中」
   - 不包含「已訂未入」數量
   - 原因：已訂未入的到貨時間不確定

3. **即時性**：
   - 標記在資料載入時計算
   - 不會即時反映庫存變化
   - 建議定期重新載入資料

4. **視覺衝突**：
   - 淺綠色背景會覆蓋表格的預設樣式
   - 使用 `!important` 確保優先級

---

## 未來改進建議

1. **加入天數倒數**：
   - 顯示「還有 X 天會缺料」
   - 幫助採購人員判斷優先順序

2. **多級警示**：
   - 7日內：深橙色
   - 15日內：淺橙色
   - 30日內：淺綠色

3. **圖示標記**：
   - 在物料編號前加上 ⚠️ 圖示
   - 更明顯的視覺提示

4. **統計資訊**：
   - 在頁面頂部顯示「30日內缺料項目：X 筆」
   - 提供快速概覽

5. **匯出功能**：
   - 匯出30日內缺料清單
   - 方便採購人員規劃

---

## 相關檔案

- `app/services/data_service.py` - 後端計算邏輯
- `app/static/js/main.js` - 前端渲染邏輯
- `app/static/css/style.css` - 視覺樣式
- `採購儀錶板更新說明.md` - 整體功能說明

---

## 技術支援

如遇到問題，請檢查：
1. 後端日誌是否有錯誤訊息
2. 瀏覽器控制台是否有 JavaScript 錯誤
3. 物料的需求日期是否正確
4. 系統時間是否正確
