# 修復物料詳情顯示問題

## 更新時間：2025-11-30 12:54

## 修復的問題

### 問題1：庫存總覽顯示全部為0
**現象：**
- 未限制庫存: 0
- 品質檢驗中: 0
- 已訂未入: 0

**原因：**
- `inventory_data` 使用原始的中文欄位名（如「未限制」、「品質檢驗中」）
- API程式碼查找的是英文欄位名（如 `unrestricted_stock`、`inspection_stock`）
- 欄位名不匹配導致取不到資料，預設為0

**解決方案：**
修改API程式碼同時支援中英文欄位名，並加入型別轉換和錯誤處理。

### 問題2：需求詳情沒有完整列出
**現象：**
- 原本有的需求工單沒有顯示
- 或顯示數量不完整

**原因：**
- 過濾條件可能過於嚴格
- 資料格式問題導致過濾掉所有項目

**解決方案：**
- 保留過濾邏輯但加入備用處理
- 如果過濾後沒有資料，使用原始資料
- 加入日誌記錄方便除錯

---

## 修改內容

### 檔案：`app/controllers/api_controller.py`

#### 修改1：庫存資料欄位處理（第84-102行）

**修改前：**
```python
# 處理庫存資料
unrestricted_stock = material_info.get('unrestricted_stock', 0)
inspection_stock = material_info.get('inspection_stock', 0)
on_order_stock = material_info.get('on_order_stock', 0)

total_available_stock = unrestricted_stock + inspection_stock
```

**修改後：**
```python
# 處理庫存資料 - 支援中英文欄位名
# inventory_data 使用中文欄位名，materials_dashboard 使用英文欄位名
unrestricted_stock = material_info.get('unrestricted_stock') or material_info.get('未限制', 0)
inspection_stock = material_info.get('inspection_stock') or material_info.get('品質檢驗中', 0)
on_order_stock = material_info.get('on_order_stock', 0)

# 確保是數字類型
try:
    unrestricted_stock = float(unrestricted_stock) if unrestricted_stock else 0
    inspection_stock = float(inspection_stock) if inspection_stock else 0
    on_order_stock = float(on_order_stock) if on_order_stock else 0
except (ValueError, TypeError):
    unrestricted_stock = 0
    inspection_stock = 0
    on_order_stock = 0

total_available_stock = unrestricted_stock + inspection_stock
```

**改進：**
- ✅ 同時嘗試讀取中英文欄位名
- ✅ 加入型別轉換確保數字格式
- ✅ 加入錯誤處理避免程式崩潰
- ✅ 空字串或None會被轉換為0

#### 修改2：需求詳情過濾邏輯（第91-101行）

**修改前：**
```python
# 2. 獲取、過濾、排序需求詳情
demand_details = [d.copy() for d in demand_map.get(material_id, [])]
demand_details = [d for d in demand_details if d.get('未結數量 (EINHEIT)', 0) > 0]

demand_details.sort(key=lambda x: x.get('需求日期') or pd.Timestamp.max, reverse=False)
```

**修改後：**
```python
# 2. 獲取、過濾、排序需求詳情
demand_details = [d.copy() for d in demand_map.get(material_id, [])]

# 只過濾掉未結數量明確為0或負數的，保留所有正數的需求
demand_details = [d for d in demand_details if d.get('未結數量 (EINHEIT)', 0) > 0]

# 如果過濾後沒有資料，保留原始資料（可能是資料格式問題）
if not demand_details and demand_map.get(material_id):
    app_logger.warning(f"物料 {material_id} 過濾後沒有需求，使用原始資料")
    demand_details = [d.copy() for d in demand_map.get(material_id, [])]

demand_details.sort(key=lambda x: x.get('需求日期') or pd.Timestamp.max, reverse=False)
```

**改進：**
- ✅ 保留過濾邏輯（過濾未結數量<=0的項目）
- ✅ 加入備用處理：如果過濾後沒資料，使用原始資料
- ✅ 加入日誌記錄，方便追蹤問題
- ✅ 確保需求資料總是會顯示

#### 修改3：替代品庫存欄位處理（第132-149行）

**修改前：**
```python
for item in inventory_data:
    item_base = str(item.get('物料', ''))[:10]
    if item_base == material_base and item.get('物料') != material_id:
        substitute_inventory.append({
            '物料': item.get('物料', ''),
            '物料說明': item.get('物料說明', ''),
            'unrestricted_stock': item.get('unrestricted_stock', 0),
            'inspection_stock': item.get('inspection_stock', 0)
        })
```

**修改後：**
```python
for item in inventory_data:
    item_base = str(item.get('物料', ''))[:10]
    if item_base == material_base and item.get('物料') != material_id:
        # 支援中英文欄位名
        sub_unrestricted = item.get('unrestricted_stock') or item.get('未限制', 0)
        sub_inspection = item.get('inspection_stock') or item.get('品質檢驗中', 0)
        
        try:
            sub_unrestricted = float(sub_unrestricted) if sub_unrestricted else 0
            sub_inspection = float(sub_inspection) if sub_inspection else 0
        except (ValueError, TypeError):
            sub_unrestricted = 0
            sub_inspection = 0
        
        substitute_inventory.append({
            '物料': item.get('物料', ''),
            '物料說明': item.get('物料說明', ''),
            'unrestricted_stock': sub_unrestricted,
            'inspection_stock': sub_inspection
        })
```

**改進：**
- ✅ 替代品庫存也支援中英文欄位名
- ✅ 加入型別轉換和錯誤處理
- ✅ 確保資料一致性

---

## 資料欄位對照表

| 中文欄位名 | 英文欄位名 | 說明 |
|-----------|-----------|------|
| 未限制 | unrestricted_stock | 未限制使用庫存 |
| 品質檢驗中 | inspection_stock | 品質檢驗中庫存 |
| 在途和移轉 | on_order_stock | 已訂未入數量 |
| 物料 | material_id | 物料編號 |
| 物料說明 | description | 物料說明 |

**資料來源差異：**
- `inventory_data`：從 Excel 直接讀取，使用**中文欄位名**
- `materials_dashboard`：經過處理的資料，使用**英文欄位名**

---

## 測試步驟

### 1. 重新啟動應用
```powershell
cd C:\app\order
# 停止現有程序
Get-Process -Name python | Where-Object {$_.Path -like "*order*"} | Stop-Process -Force

# 重新啟動
.\start_order_server.ps1
```

### 2. 測試庫存總覽
1. 開啟採購儀錶板
2. 點擊任一物料編號（藍色連結）
3. 檢查庫存總覽區塊：
   - ✅ 未限制庫存應顯示正確數字
   - ✅ 品質檢驗中應顯示正確數字
   - ✅ 已訂未入應顯示正確數字

### 3. 測試需求詳情
1. 在同一個模態視窗中
2. 查看「需求訂單列表」分頁
3. 確認：
   - ✅ 所有有需求的訂單都有列出
   - ✅ 未結數量正確顯示
   - ✅ 需求日期正確顯示
   - ✅ 預計剩餘庫存正確計算

### 4. 測試替代品
1. 切換到「可替代版本」分頁
2. 確認：
   - ✅ 替代品清單正確顯示
   - ✅ 庫存數字正確顯示

---

## 驗證清單

- ✅ Python語法檢查通過
- ✅ 支援中英文欄位名
- ✅ 加入型別轉換和錯誤處理
- ⏳ 等待重新啟動測試

---

## 日誌檢查

如果還有問題，檢查 `app_errors.log` 中的訊息：

```
2025-11-30 12:54:xx - WARNING - 物料 XXXXXXXXX 過濾後沒有需求，使用原始資料
```

這表示該物料的需求資料可能有格式問題。

---

## 相關檔案

- `app/controllers/api_controller.py` - 物料詳情API
- `app/services/data_service.py` - 資料處理服務
- `app_errors.log` - 錯誤日誌

---

## 後續改進建議

1. **統一欄位命名**：
   - 在資料處理階段就統一轉換為英文欄位名
   - 避免在多處需要處理中英文對照

2. **資料驗證**：
   - 在載入資料時就驗證數字欄位
   - 提前發現和記錄資料格式問題

3. **錯誤追蹤**：
   - 加入更詳細的日誌記錄
   - 記錄哪些資料被過濾掉了

4. **單元測試**：
   - 測試中英文欄位都能正確讀取
   - 測試型別轉換的各種情況
